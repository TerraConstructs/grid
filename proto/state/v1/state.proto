syntax = "proto3";

package state.v1;

import "google/protobuf/timestamp.proto";

option go_package = "github.com/terraconstructs/grid/api/state/v1;statev1";

// StateService provides remote state management for Terraform/OpenTofu clients.
service StateService {
  // CreateState creates a new state with client-generated GUID and logic ID.
  rpc CreateState(CreateStateRequest) returns (CreateStateResponse);

  // ListStates returns all states with summary information.
  rpc ListStates(ListStatesRequest) returns (ListStatesResponse);

  // GetStateConfig retrieves backend configuration for an existing state by logic ID.
  rpc GetStateConfig(GetStateConfigRequest) returns (GetStateConfigResponse);

  // GetStateLock inspects the current lock metadata for a state by GUID.
  rpc GetStateLock(GetStateLockRequest) returns (GetStateLockResponse);

  // UnlockState releases a lock using the lock ID provided by Terraform/OpenTofu.
  rpc UnlockState(UnlockStateRequest) returns (UnlockStateResponse);

  // --- Dependency Management RPCs ---

  // AddDependency declares a dependency edge from producer output to consumer state.
  // Returns existing edge if duplicate (idempotent). Rejects if would create cycle.
  rpc AddDependency(AddDependencyRequest) returns (AddDependencyResponse);

  // RemoveDependency deletes a dependency edge by ID.
  rpc RemoveDependency(RemoveDependencyRequest) returns (RemoveDependencyResponse);

  // ListDependencies returns all edges where the given state is the consumer (incoming deps).
  rpc ListDependencies(ListDependenciesRequest) returns (ListDependenciesResponse);

  // ListDependents returns all edges where the given state is the producer (outgoing deps).
  rpc ListDependents(ListDependentsRequest) returns (ListDependentsResponse);

  // SearchByOutput finds all edges that reference a specific output key (by name).
  rpc SearchByOutput(SearchByOutputRequest) returns (SearchByOutputResponse);

  // GetTopologicalOrder computes layered ordering of states rooted at given state.
  rpc GetTopologicalOrder(GetTopologicalOrderRequest) returns (GetTopologicalOrderResponse);

  // GetStateStatus computes on-demand status for a state based on its incoming edges.
  rpc GetStateStatus(GetStateStatusRequest) returns (GetStateStatusResponse);

  // GetDependencyGraph returns full dependency graph data for client-side HCL generation.
  rpc GetDependencyGraph(GetDependencyGraphRequest) returns (GetDependencyGraphResponse);

  // ListStateOutputs returns available output keys from a state's Terraform/OpenTofu JSON.
  // Output values are NOT returned (security/size concerns); only keys and sensitive flags.
  // Used by CLI for interactive output selection when creating dependencies.
  rpc ListStateOutputs(ListStateOutputsRequest) returns (ListStateOutputsResponse);

  // GetStateInfo retrieves comprehensive state information including:
  // - Basic metadata (GUID, logic-id, timestamps)
  // - Backend configuration (Terraform HTTP backend URLs)
  // - Dependencies (incoming edges: states this state depends on)
  // - Dependents (outgoing edges: states that depend on this state)
  // - Outputs (available Terraform output keys from state JSON)
  //
  // This consolidates information previously requiring multiple RPC calls.
  rpc GetStateInfo(GetStateInfoRequest) returns (GetStateInfoResponse);

  // ListAllEdges returns all dependency edges in the system.
  // Used by dashboards and monitoring tools to visualize complete topology.
  // Returns edges in ascending order by ID (database insertion order).
  rpc ListAllEdges(ListAllEdgesRequest) returns (ListAllEdgesResponse);

  // --- Label Management RPCs ---

  // UpdateStateLabels mutates labels for an existing state (add/replace/remove).
  rpc UpdateStateLabels(UpdateStateLabelsRequest) returns (UpdateStateLabelsResponse);

  // GetLabelPolicy retrieves the current label validation policy.
  rpc GetLabelPolicy(GetLabelPolicyRequest) returns (GetLabelPolicyResponse);

  // SetLabelPolicy updates the label validation policy with version increment.
  rpc SetLabelPolicy(SetLabelPolicyRequest) returns (SetLabelPolicyResponse);

  // Service Account Management
  rpc CreateServiceAccount(CreateServiceAccountRequest) returns (CreateServiceAccountResponse);
  rpc ListServiceAccounts(ListServiceAccountsRequest) returns (ListServiceAccountsResponse);
  rpc RevokeServiceAccount(RevokeServiceAccountRequest) returns (RevokeServiceAccountResponse);
  rpc RotateServiceAccount(RotateServiceAccountRequest) returns (RotateServiceAccountResponse);

  // Role Management
  rpc CreateRole(CreateRoleRequest) returns (CreateRoleResponse);
  rpc ListRoles(ListRolesRequest) returns (ListRolesResponse);
  rpc UpdateRole(UpdateRoleRequest) returns (UpdateRoleResponse);
  rpc DeleteRole(DeleteRoleRequest) returns (DeleteRoleResponse);

  // Role Assignment (User/Service Account)
  rpc AssignRole(AssignRoleRequest) returns (AssignRoleResponse);
  rpc RemoveRole(RemoveRoleRequest) returns (RemoveRoleResponse);
  rpc ListUserRoles(ListUserRolesRequest) returns (ListUserRolesResponse);

  // Group-to-Role Management
  rpc AssignGroupRole(AssignGroupRoleRequest) returns (AssignGroupRoleResponse);
  rpc RemoveGroupRole(RemoveGroupRoleRequest) returns (RemoveGroupRoleResponse);
  rpc ListGroupRoles(ListGroupRolesRequest) returns (ListGroupRolesResponse);

  // Permission Introspection
  rpc GetEffectivePermissions(GetEffectivePermissionsRequest) returns (GetEffectivePermissionsResponse);

  // Session Management
  rpc ListSessions(ListSessionsRequest) returns (ListSessionsResponse);
  rpc RevokeSession(RevokeSessionRequest) returns (RevokeSessionResponse);

  // --- Output Schema Management RPCs ---

  // SetOutputSchema publishes or updates a JSON Schema for a specific state output.
  // This allows clients to declare expected output types before the output exists.
  rpc SetOutputSchema(SetOutputSchemaRequest) returns (SetOutputSchemaResponse);

  // GetOutputSchema retrieves the JSON Schema for a specific state output.
  rpc GetOutputSchema(GetOutputSchemaRequest) returns (GetOutputSchemaResponse);
}

// CreateStateRequest creates a new state using a client-generated GUID.
message CreateStateRequest {
  string guid = 1;
  string logic_id = 2;
  map<string, string> labels = 3;
}

// CreateStateResponse confirms creation and returns backend config.
message CreateStateResponse {
  string guid = 1;
  string logic_id = 2;
  BackendConfig backend_config = 3;
}

// ListStatesRequest requests all states.
message ListStatesRequest {
  // Optional bexpr filter expression (e.g., 'env == "staging"')
  optional string filter = 1;

  // Whether to include labels in response (default: true)
  optional bool include_labels = 2;

  // Whether to compute and include dependency status for each state (default: true for backward compatibility)
  // WARNING: This requires computing status for EVERY state which can be expensive (N+1 pattern).
  // Set to false if you don't need real-time status to improve performance significantly.
  optional bool include_status = 3;
}

// ListStatesResponse returns all states with basic info.
message ListStatesResponse {
  repeated StateInfo states = 1;
}

// StateInfo is summary information for a state.
message StateInfo {
  string guid = 1;
  string logic_id = 2;
  bool locked = 3;
  google.protobuf.Timestamp created_at = 4;
  google.protobuf.Timestamp updated_at = 5;
  int64 size_bytes = 6;
  // Derived status fields for quick indicators
  optional string computed_status = 7; // "clean", "stale", "potentially-stale"
  repeated string dependency_logic_ids = 8; // Unique set of producer logic_ids (incoming edges)
  // State labels (key-value pairs with typed values)
  map<string, LabelValue> labels = 9;

  // Relationship counts for efficient list rendering (eliminates N+1 pattern in frontend)
  // These counts are populated from database relationships without fetching full edge/output data
  // Using optional to ensure zero values are always serialized in JSON
  optional int32 dependencies_count = 10;  // Number of incoming dependency edges
  optional int32 dependents_count = 11;    // Number of outgoing dependency edges
  optional int32 outputs_count = 12;        // Number of outputs available from this state
}

// BackendConfig contains Terraform backend configuration URLs.
message BackendConfig {
  string address = 1;
  string lock_address = 2;
  string unlock_address = 3;
}

// GetStateConfigRequest retrieves backend config for existing state.
message GetStateConfigRequest {
  string logic_id = 1;
}

// GetStateConfigResponse returns backend config.
message GetStateConfigResponse {
  string guid = 1;
  BackendConfig backend_config = 2;
}

// GetStateLockRequest fetches current lock metadata by GUID.
message GetStateLockRequest {
  string guid = 1;
}

// LockInfo mirrors Terraform's lock payload.
message LockInfo {
  string id = 1;
  string operation = 2;
  string info = 3;
  string who = 4;
  string version = 5;
  google.protobuf.Timestamp created = 6;
  string path = 7;
}

// StateLock response wrapper indicating lock state plus metadata when present.
message StateLock {
  bool locked = 1;
  LockInfo info = 2;
}

// GetStateLockResponse returns current lock status.
message GetStateLockResponse {
  StateLock lock = 1;
}

// UnlockStateRequest releases a lock given the current lock ID.
message UnlockStateRequest {
  string guid = 1;
  string lock_id = 2;
}

// UnlockStateResponse mirrors GetStateLockResponse after unlock attempt.
message UnlockStateResponse {
  StateLock lock = 1;
}

// --- Dependency Management Messages ---

// AddDependencyRequest creates a new dependency edge.
message AddDependencyRequest {
  // Producer state reference (logic_id or GUID, prefer logic_id for UX)
  oneof from_state {
    string from_logic_id = 1;
    string from_guid = 2;
  }

  // Output key from producer state
  string from_output = 3;

  // Consumer state reference (logic_id or GUID)
  oneof to_state {
    string to_logic_id = 4;
    string to_guid = 5;
  }

  // Optional override for generated HCL local variable name
  optional string to_input_name = 6;

  // Optional mock value for ahead-of-time dependency declaration
  // (JSON-encoded value, used when producer output doesn't exist yet)
  optional string mock_value_json = 7;
}

// AddDependencyResponse returns the created or existing edge.
message AddDependencyResponse {
  DependencyEdge edge = 1;
  bool already_exists = 2; // True if edge already existed (idempotent)
}

// RemoveDependencyRequest deletes an edge by ID.
message RemoveDependencyRequest {
  int64 edge_id = 1;
}

// RemoveDependencyResponse confirms deletion.
message RemoveDependencyResponse {
  bool success = 1;
}

// ListDependenciesRequest fetches incoming edges for a consumer state.
message ListDependenciesRequest {
  // Consumer state reference (logic_id or GUID)
  oneof state {
    string logic_id = 1;
    string guid = 2;
  }
}

// ListDependenciesResponse returns all incoming edges.
message ListDependenciesResponse {
  repeated DependencyEdge edges = 1;
}

// ListDependentsRequest fetches outgoing edges for a producer state.
message ListDependentsRequest {
  // Producer state reference (logic_id or GUID)
  oneof state {
    string logic_id = 1;
    string guid = 2;
  }
}

// ListDependentsResponse returns all outgoing edges.
message ListDependentsResponse {
  repeated DependencyEdge edges = 1;
}

// SearchByOutputRequest finds edges by output key name.
message SearchByOutputRequest {
  string output_key = 1;
}

// SearchByOutputResponse returns matching edges.
message SearchByOutputResponse {
  repeated DependencyEdge edges = 1;
}

// GetTopologicalOrderRequest computes layered ordering rooted at a state.
message GetTopologicalOrderRequest {
  // Root state reference (logic_id or GUID)
  oneof state {
    string logic_id = 1;
    string guid = 2;
  }

  // Direction: "downstream" (default) or "upstream"
  optional string direction = 3;
}

// GetTopologicalOrderResponse returns layered state ordering.
message GetTopologicalOrderResponse {
  repeated Layer layers = 1;
}

// Layer represents a level in the topological ordering.
message Layer {
  int32 level = 1;
  repeated StateRef states = 2;
}

// StateRef is a minimal state reference.
message StateRef {
  string guid = 1;
  string logic_id = 2;
}

// GetStateStatusRequest computes on-demand status for a state.
message GetStateStatusRequest {
  // State reference (logic_id or GUID)
  oneof state {
    string logic_id = 1;
    string guid = 2;
  }
}

// GetStateStatusResponse returns computed status with incoming edges.
message GetStateStatusResponse {
  string guid = 1;
  string logic_id = 2;
  string status = 3; // "clean", "stale", "potentially-stale"
  repeated IncomingEdgeView incoming = 4;
  StatusSummary summary = 5;
}

// IncomingEdgeView shows incoming edge details for status computation.
message IncomingEdgeView {
  int64 edge_id = 1;
  string from_guid = 2;
  string from_logic_id = 3;
  string from_output = 4;
  string status = 5; // Edge status: "clean", "dirty", "pending", etc.
  optional string in_digest = 6;
  optional string out_digest = 7;
  optional google.protobuf.Timestamp last_in_at = 8;
  optional google.protobuf.Timestamp last_out_at = 9;
}

// StatusSummary aggregates incoming edge counts.
message StatusSummary {
  int32 incoming_clean = 1;
  int32 incoming_dirty = 2;
  int32 incoming_pending = 3;
  int32 incoming_unknown = 4;
}

// GetDependencyGraphRequest fetches graph data for consumer state HCL generation.
message GetDependencyGraphRequest {
  // Consumer state reference (logic_id or GUID)
  oneof state {
    string logic_id = 1;
    string guid = 2;
  }
}

// GetDependencyGraphResponse returns data needed for grid_dependencies.tf generation.
message GetDependencyGraphResponse {
  string consumer_guid = 1;
  string consumer_logic_id = 2;
  repeated ProducerState producers = 3;
  repeated DependencyEdge edges = 4;
}

// ProducerState represents a unique producer state in the graph.
message ProducerState {
  string guid = 1;
  string logic_id = 2;
  BackendConfig backend_config = 3;
}

// DependencyEdge represents a directed dependency edge.
message DependencyEdge {
  int64 id = 1;
  string from_guid = 2;
  string from_logic_id = 3;
  string from_output = 4;
  string to_guid = 5;
  string to_logic_id = 6;
  optional string to_input_name = 7;

  // Edge status combines two orthogonal dimensions:
  // 1. Drift: clean (in_digest == out_digest) vs dirty (in_digest != out_digest)
  // 2. Validation: valid (passes schema) vs invalid (fails schema)
  //
  // Possible values:
  // - "pending": Initial state, no observation yet
  // - "clean": in_digest == out_digest AND output passes schema validation
  // - "clean-invalid": in_digest == out_digest AND output fails schema validation
  // - "dirty": in_digest != out_digest AND output passes schema validation
  // - "dirty-invalid": in_digest != out_digest AND output fails schema validation
  // - "potentially-stale": Transitive upstream dirty
  // - "mock": Using mock_value, real output does not exist yet
  // - "missing-output": Producer does not have the required output key
  string status = 8;

  optional string in_digest = 9;
  optional string out_digest = 10;
  optional string mock_value_json = 11;
  optional google.protobuf.Timestamp last_in_at = 12;
  optional google.protobuf.Timestamp last_out_at = 13;
  google.protobuf.Timestamp created_at = 14;
  google.protobuf.Timestamp updated_at = 15;
}

// --- Outputs Caching Messages ---

// OutputKey represents a single Terraform/OpenTofu output name and metadata.
message OutputKey {
  // Output name from Terraform state JSON (e.g., "vpc_id", "db_password")
  string key = 1;

  // Whether output is marked sensitive in Terraform state metadata
  // Used by CLI to display warning: "⚠️  sensitive" next to output name
  bool sensitive = 2;

  // JSON Schema definition for this output (if one has been set via SetOutputSchema).
  // This field is optional and only populated when schema metadata is available.
  // Allows clients to understand the expected type structure without fetching values.
  optional string schema_json = 3;

  // Schema source indicates whether the schema was manually set or automatically inferred.
  // Values: "manual" (explicitly set via SetOutputSchema) or "inferred" (auto-generated from output values)
  // This field is optional and only populated when schema_json is non-null.
  optional string schema_source = 4;

  // Validation status indicates the result of JSON Schema validation.
  // Values: "valid" (passed validation), "invalid" (failed validation), "error" (validation system error)
  // This field is optional and only populated when schema_json is non-null and validation has run.
  optional string validation_status = 5;

  // Validation error contains the validation error message with JSON path information.
  // This field is optional and only populated when validation_status is "invalid" or "error".
  optional string validation_error = 6;

  // Validated at is the timestamp of the last validation run.
  // This field is optional and only populated when validation has run.
  optional google.protobuf.Timestamp validated_at = 7;
}

// ListStateOutputsRequest fetches output keys for a state.
message ListStateOutputsRequest {
  // State identifier (prefer logic_id for UX, guid for precision)
  oneof state {
    string logic_id = 1; // User-friendly state identifier
    string guid = 2; // Immutable UUIDv7 identifier
  }
}

// ListStateOutputsResponse returns output keys parsed from Terraform state JSON.
message ListStateOutputsResponse {
  // State identifiers for confirmation
  string state_guid = 1;
  string state_logic_id = 2;

  // List of output keys available in this state's Terraform JSON
  // Empty array if state has no outputs (not an error)
  repeated OutputKey outputs = 3;
}

// GetStateInfoRequest fetches full state information.
message GetStateInfoRequest {
  // State identifier (prefer logic_id for UX, guid for precision)
  oneof state {
    string logic_id = 1; // User-friendly state identifier
    string guid = 2; // Immutable UUIDv7 identifier
  }
}

// GetStateInfoResponse returns comprehensive state view.
message GetStateInfoResponse {
  // State identifiers
  string guid = 1;
  string logic_id = 2;

  // Terraform HTTP backend configuration
  BackendConfig backend_config = 3;

  // Incoming dependency edges (this state consumes outputs from these states)
  // Equivalent to: SELECT * FROM edges WHERE to_guid = this.guid
  repeated DependencyEdge dependencies = 4;

  // Outgoing dependency edges (other states consume this state's outputs)
  // Equivalent to: SELECT * FROM edges WHERE from_guid = this.guid
  repeated DependencyEdge dependents = 5;

  // Available outputs from this state's Terraform JSON (keys only, no values)
  // Empty array if state has no Terraform state JSON uploaded yet
  repeated OutputKey outputs = 6;

  // State lifecycle timestamps
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;

  // Computed status based on incoming dependency edges
  optional string computed_status = 9; // "clean", "stale", "potentially-stale"

  // State JSON size in bytes (calculated without including state JSON in response)
  int64 size_bytes = 10;

  // State labels (key-value pairs with typed values)
  map<string, LabelValue> labels = 11;
}

// ListAllEdgesRequest currently has no parameters.
// Future: Add filtering, pagination, sorting options.
message ListAllEdgesRequest {
  // No fields for PoC (returns all edges)

  // Future enhancements (not in PoC):
  // optional string status_filter = 1;  // e.g., "dirty", "clean"
  // optional int32 page_size = 2;
  // optional string page_token = 3;
}

// ListAllEdgesResponse contains all dependency edges.
message ListAllEdgesResponse {
  repeated DependencyEdge edges = 1;

  // Future enhancements (not in PoC):
  // optional string next_page_token = 2;
  // optional int32 total_count = 3;
}

// --- Label Management Messages ---

// LabelValue represents a typed label value (string, number, or boolean).
message LabelValue {
  oneof value {
    string string_value = 1;
    double number_value = 2;
    bool bool_value = 3;
  }
}

// UpdateStateLabelsRequest mutates labels for an existing state.
message UpdateStateLabelsRequest {
  // State identifier (GUID)
  string state_id = 1;

  // Labels to add or update (key-value pairs)
  map<string, LabelValue> adds = 2;

  // Label keys to remove
  repeated string removals = 3;

  // Optional idempotency token
  optional string client_request_id = 4;
}

// UpdateStateLabelsResponse returns updated label set.
message UpdateStateLabelsResponse {
  string state_id = 1;
  map<string, LabelValue> labels = 2;
  int32 policy_version = 3;
  string compliance_status = 4; // "COMPLIANT" or "NON_COMPLIANT"
  google.protobuf.Timestamp updated_at = 5;
}

// GetLabelPolicyRequest retrieves the current policy.
message GetLabelPolicyRequest {
  // No parameters - returns active policy
}

// GetLabelPolicyResponse returns the label validation policy.
message GetLabelPolicyResponse {
  int32 version = 1;
  string policy_json = 2; // JSON-encoded PolicyDefinition
  google.protobuf.Timestamp created_at = 3;
  google.protobuf.Timestamp updated_at = 4;
}

// SetLabelPolicyRequest updates the policy.
message SetLabelPolicyRequest {
  // JSON-encoded PolicyDefinition (see data-model.md)
  string policy_json = 1;
}

// SetLabelPolicyResponse confirms policy update.
message SetLabelPolicyResponse {
  int32 version = 1; // Incremented version number
  google.protobuf.Timestamp updated_at = 2;
}

// ========== Service Account Management ==========

message CreateServiceAccountRequest {
  string name = 1;
  optional string description = 2;
}

message CreateServiceAccountResponse {
  string id = 1;
  string client_id = 2;
  string client_secret = 3; // Only returned once on creation
  string name = 4;
  google.protobuf.Timestamp created_at = 5;
}

message ListServiceAccountsRequest {
  // Future: Add pagination
}

message ServiceAccountInfo {
  string id = 1;
  string client_id = 2;
  string name = 3;
  optional string description = 4;
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp last_used_at = 6;
  bool disabled = 7;
}

message ListServiceAccountsResponse {
  repeated ServiceAccountInfo service_accounts = 1;
}

message RevokeServiceAccountRequest {
  string client_id = 1;
}

message RevokeServiceAccountResponse {
  bool success = 1;
}

message RotateServiceAccountRequest {
  string client_id = 1; // Service account to rotate credentials for
}

message RotateServiceAccountResponse {
  string client_id = 1; // Same client_id (identity preserved)
  string client_secret = 2; // New secret (only returned once)
  google.protobuf.Timestamp rotated_at = 3;
}

// ========== Role Management ==========

message CreateRoleRequest {
  string name = 1;
  optional string description = 2;
  repeated string actions = 3; // e.g., ["state:create", "tfstate:*"]
  optional string label_scope_expr = 4; // go-bexpr expression (e.g., "env == \"dev\"" or "env == \"dev\" and team == \"platform\" or team == \"sre\"")
  optional CreateConstraints create_constraints = 5;
  repeated string immutable_keys = 6;
}

// LabelScope has been replaced with label_scope_expr string field
// to support go-bexpr expressions for arbitrary boolean logic

message CreateConstraints {
  // Map of label key to constraint definition
  map<string, CreateConstraint> constraints = 1;
}

message CreateConstraint {
  repeated string allowed_values = 1;
  bool required = 2;
}

message RoleInfo {
  string id = 1;
  string name = 2;
  optional string description = 3;
  repeated string actions = 4;
  optional string label_scope_expr = 5; // go-bexpr expression evaluated at enforcement time
  optional CreateConstraints create_constraints = 6;
  repeated string immutable_keys = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp updated_at = 9;
  int32 version = 10;
}

message CreateRoleResponse {
  RoleInfo role = 1;
}

message ListRolesRequest {
  // Future: Add filtering
}

message ListRolesResponse {
  repeated RoleInfo roles = 1;
}

message UpdateRoleRequest {
  string name = 1; // Role to update
  optional string description = 2;
  repeated string actions = 3;
  optional string label_scope_expr = 4; // go-bexpr expression (e.g., "env == \"dev\" and team == \"platform\"")
  optional CreateConstraints create_constraints = 5;
  repeated string immutable_keys = 6;
  int32 expected_version = 7; // Optimistic locking
}

message UpdateRoleResponse {
  RoleInfo role = 1;
}

message DeleteRoleRequest {
  string name = 1;
}

message DeleteRoleResponse {
  bool success = 1;
}

// ========== Role Assignment ==========

message AssignRoleRequest {
  string principal_type = 1; // "user" or "service_account"
  string principal_id = 2; // UUID
  string role_name = 3;
}

message AssignRoleResponse {
  bool success = 1;
  google.protobuf.Timestamp assigned_at = 2;
}

message RemoveRoleRequest {
  string principal_type = 1;
  string principal_id = 2;
  string role_name = 3;
}

message RemoveRoleResponse {
  bool success = 1;
}

message ListUserRolesRequest {
  string principal_type = 1;
  string principal_id = 2;
}

message RoleAssignmentInfo {
  string role_name = 1;
  google.protobuf.Timestamp assigned_at = 2;
  string assigned_by_user_id = 3;
}

message ListUserRolesResponse {
  repeated RoleAssignmentInfo roles = 1;
}

// ========== Group-to-Role Management ==========

message AssignGroupRoleRequest {
  string group_name = 1; // Group name as it appears in JWT claims (e.g., "dev-team", "platform-engineers")
  string role_name = 2;
}

message AssignGroupRoleResponse {
  bool success = 1;
  google.protobuf.Timestamp assigned_at = 2;
}

message RemoveGroupRoleRequest {
  string group_name = 1;
  string role_name = 2;
}

message RemoveGroupRoleResponse {
  bool success = 1;
}

message ListGroupRolesRequest {
  optional string group_name = 1; // If provided, list roles for specific group; if omitted, list all group-role mappings
}

message GroupRoleAssignmentInfo {
  string group_name = 1;
  string role_name = 2;
  google.protobuf.Timestamp assigned_at = 3;
  string assigned_by_user_id = 4;
}

message ListGroupRolesResponse {
  repeated GroupRoleAssignmentInfo assignments = 1;
}

// ========== Permission Introspection ==========

message GetEffectivePermissionsRequest {
  string principal_type = 1;
  string principal_id = 2;
}

message EffectivePermissions {
  repeated string roles = 1; // Role names
  repeated string actions = 2; // Aggregated actions (e.g., ["state:*", "tfstate:read"])
  repeated string label_scope_exprs = 3; // List of go-bexpr expressions from all roles (union/OR semantics - access granted if ANY expression matches)
  optional CreateConstraints effective_create_constraints = 4;
  repeated string effective_immutable_keys = 5; // Union of all immutable keys
}

message GetEffectivePermissionsResponse {
  EffectivePermissions permissions = 1;
}

// ========== Session Management ==========

message ListSessionsRequest {
  string user_id = 1;
}

message SessionInfo {
  string id = 1;
  google.protobuf.Timestamp created_at = 2;
  google.protobuf.Timestamp last_used_at = 3;
  google.protobuf.Timestamp expires_at = 4;
  optional string user_agent = 5;
  optional string ip_address = 6;
}

message ListSessionsResponse {
  repeated SessionInfo sessions = 1;
}

message RevokeSessionRequest {
  string session_id = 1;
}

message RevokeSessionResponse {
  bool success = 1;
}

// --- Output Schema Management Messages ---

// SetOutputSchemaRequest publishes or updates a JSON Schema for a specific state output.
// Allows clients to declare expected output types before the output actually exists.
message SetOutputSchemaRequest {
  // State identifier (logic_id or GUID)
  oneof state {
    string state_logic_id = 1;
    string state_guid = 2;
  }

  // Name of the output (e.g., "vpc_id", "subnet_ids")
  string output_key = 3;

  // JSON Schema definition for this output (must be valid JSON Schema)
  // Example: {"type": "string", "pattern": "^vpc-[a-z0-9]+$"}
  string schema_json = 4;
}

// SetOutputSchemaResponse confirms schema publication.
message SetOutputSchemaResponse {
  bool success = 1;

  // State identifiers for confirmation
  string state_guid = 2;
  string state_logic_id = 3;
  string output_key = 4;
}

// GetOutputSchemaRequest retrieves the JSON Schema for a specific state output.
message GetOutputSchemaRequest {
  // State identifier (logic_id or GUID)
  oneof state {
    string state_logic_id = 1;
    string state_guid = 2;
  }

  // Name of the output to get schema for
  string output_key = 3;
}

// GetOutputSchemaResponse returns the JSON Schema for an output.
message GetOutputSchemaResponse {
  // State identifiers
  string state_guid = 1;
  string state_logic_id = 2;

  // Output name
  string output_key = 3;

  // JSON Schema definition (empty string if no schema has been set)
  string schema_json = 4;
}

