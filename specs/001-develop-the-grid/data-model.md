# Data Model: Terraform State Management

**Feature**: 001-develop-the-grid
**Date**: 2025-09-30
**Status**: Complete

## Entity Definitions

### State

Represents a Terraform/OpenTofu state file with metadata and content.

**Fields**:
- `guid` (string, primary key, immutable)
  - **UUIDv7 format** (e.g., "018e8c5e-7890-7000-8000-123456789abc")
  - **Generated by CLI client** on creation (per specification)
  - Timestamp-ordered for optimal Postgres B-tree index performance
  - Used in Terraform backend URLs: `/tfstate/{guid}`
  - Validation: RFC 9562 UUIDv7 format (but accept any valid UUID)

- `logic_id` (string, unique, mutable)
  - Human-readable identifier (e.g., "production-us-east")
  - User-provided, globally unique across all states
  - Used for CLI commands: `gridctl state init production-us-east`
  - Validation: non-empty, max 128 characters, alphanumeric + hyphens/underscores

- `state_content` (bytea/text, nullable)
  - Terraform state JSON blob
  - Stored as-is from Terraform POST requests
  - Null when state created but never initialized by Terraform
  - No size limit (database constraint), warning at 10MB

- `locked` (boolean, default false)
  - Indicates if state is currently locked
  - Prevents concurrent Terraform operations

- `lock_info` (jsonb, nullable)
  - Lock metadata when locked=true
  - Contains: ID, Operation, Who, Version, Created, Path
  - Null when locked=false

- `created_at` (timestamp with timezone)
  - State creation timestamp
  - Set by API server, immutable

- `updated_at` (timestamp with timezone)
  - Last state content update timestamp
  - Updated on each Terraform POST

**Relationships**:
- None (single entity model for initial version)

**Indexes**:
- Primary key on `guid`
- Unique index on `logic_id`
- Index on `created_at` for list ordering

**Constraints**:
- `logic_id` must be globally unique (enforced by unique index)
- `guid` format validated by UUID library before insert
- When `locked=true`, `lock_info` must not be null
- When `locked=false`, `lock_info` must be null

**State Transitions**:
1. **Created**: Client generates `guid` (UUIDv7), sends CreateState with `guid` + `logic_id`, server persists with `state_content=null`, `locked=false`
2. **Initialized**: Terraform POST sets `state_content` (first time)
3. **Updated**: Terraform POST updates `state_content`, `updated_at`
4. **Locked**: `locked=true`, `lock_info` set with lock metadata
5. **Unlocked**: `locked=false`, `lock_info=null`

**Size Behavior**:
- Accept all state content sizes
- Log warning when `len(state_content) > 10MB`
- Return `X-Grid-State-Size-Warning` header on POST response

## Database Schema

### PostgreSQL Table: `states`

**Schema** (generated by Bun CreateTable from Go struct):
```sql
CREATE TABLE states (
  guid          UUID PRIMARY KEY,
  logic_id      VARCHAR(128) NOT NULL UNIQUE,
  state_content BYTEA,
  locked        BOOLEAN NOT NULL DEFAULT FALSE,
  lock_info     JSONB,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,

  CONSTRAINT logic_id_not_empty CHECK (LENGTH(logic_id) > 0),
  CONSTRAINT lock_consistency CHECK (
    (locked = TRUE AND lock_info IS NOT NULL) OR
    (locked = FALSE AND lock_info IS NULL)
  )
);

CREATE INDEX idx_states_created_at ON states(created_at DESC);
```

**Notes**:
- UUID type is native Postgres (no extensions required)
- UUIDv7 timestamp prefix provides sequential primary key inserts (better B-tree performance)
- BYTEA type for state_content (binary storage for large JSON blobs)
- JSONB type for lock_info (native Postgres, no extensions required)

**Migration File**: `cmd/gridapi/internal/migrations/20250930000001_create_states_table.go` (Go-based Bun migration, not SQL file)

## Go Struct Definitions

### Internal Persistence Model (API Server)

```go
package repository // cmd/gridapi/internal/db/repository

import (
  "time"

  "github.com/uptrace/bun"
)

// State represents a Terraform state managed by Grid
type State struct {
  bun.BaseModel `bun:"table:states,alias:s"`

  GUID         string     `bun:"guid,pk,type:uuid"`
  LogicID      string     `bun:"logic_id,notnull,unique"`
  StateContent []byte     `bun:"state_content,type:bytea"`
  Locked       bool       `bun:"locked,notnull,default:false"`
  LockInfo     *LockInfo  `bun:"lock_info,type:jsonb"`
  CreatedAt    time.Time  `bun:"created_at,notnull,default:current_timestamp"`
  UpdatedAt    time.Time  `bun:"updated_at,notnull,default:current_timestamp"`
}

// LockInfo mirrors Terraform's lock payload for 423 responses
type LockInfo struct {
  ID        string    `json:"ID"`
  Operation string    `json:"Operation"`
  Info      string    `json:"Info"`
  Who       string    `json:"Who"`
  Version   string    `json:"Version"`
  Created   time.Time `json:"Created"`
  Path      string    `json:"Path"`
}

const stateSizeWarningThreshold = 10 * 1024 * 1024 // 10MB

func (s *State) SizeExceedsThreshold() bool {
  return len(s.StateContent) > stateSizeWarningThreshold
}
```

### Internal Validation Helpers

```go
package state // cmd/gridapi/internal/state

import (
  "errors"

  "github.com/google/uuid"
  "github.com/terraconstructs/grid/cmd/gridapi/internal/db/repository"
)

func ValidateCreateInput(guid, logicID string) error {
  if _, err := uuid.Parse(guid); err != nil {
    return errors.New("guid must be a valid UUID")
  }
  if logicID == "" {
    return errors.New("logic_id is required")
  }
  if len(logicID) > 128 {
    return errors.New("logic_id exceeds maximum length")
  }
  return nil
}

func ValidateLockTransition(locked bool, lockInfo *repository.LockInfo) error {
  if locked && lockInfo == nil {
    return errors.New("locked state must include lock_info")
  }
  if !locked && lockInfo != nil {
    return errors.New("unlocking requires lock_info to be cleared")
  }
  return nil
}
```

### SDK DTOs (Connect Clients)

```go
package sdk // pkg/sdk

import (
  "context"

  "github.com/connectrpc/connect"
  statev1 "github.com/terraconstructs/grid/api/state/v1"
  statev1connect "github.com/terraconstructs/grid/api/state/v1/statev1connect"
)

type Client struct {
  rpc statev1connect.StateServiceClient
}

func (c *Client) CreateState(ctx context.Context, guid, logicID string) (*statev1.CreateStateResponse, error) {
  req := connect.NewRequest(&statev1.CreateStateRequest{Guid: guid, LogicId: logicID})
  res, err := c.rpc.CreateState(ctx, req)
  if err != nil {
    return nil, err
  }
  return res.Msg, nil
}

// BackendConfig represents generated Terraform backend configuration
type BackendConfig struct {
  Address       string `json:"address"`
  LockAddress   string `json:"lock_address"`
  UnlockAddress string `json:"unlock_address"`
}

func (c *Client) GetStateLock(ctx context.Context, guid string) (*statev1.GetStateLockResponse, error) {
  req := connect.NewRequest(&statev1.GetStateLockRequest{Guid: guid})
  res, err := c.rpc.GetStateLock(ctx, req)
  if err != nil {
    return nil, err
  }
  return res.Msg, nil
}

func (c *Client) UnlockState(ctx context.Context, guid, lockID string) error {
  req := connect.NewRequest(&statev1.UnlockStateRequest{Guid: guid, LockId: lockID})
  _, err := c.rpc.UnlockState(ctx, req)
  return err
}
```

SDK packages never embed persistence or Bun codeâ€”they forward requests to the generated Connect client and operate directly on the protobuf-generated types in `github.com/terraconstructs/grid/api/state/v1` (no additional DTO structs).

## Protobuf Definitions

### State Service Messages

```protobuf
syntax = "proto3";

package grid.state.v1;

import "google/protobuf/timestamp.proto";

// CreateStateRequest creates a new state with client-generated GUID and logic_id
message CreateStateRequest {
  string guid = 1;      // Client-generated UUIDv7
  string logic_id = 2;  // User-provided human-readable identifier
}

// CreateStateResponse confirms creation and returns backend config
message CreateStateResponse {
  string guid = 1;
  string logic_id = 2;
  BackendConfig backend_config = 3;
}

// ListStatesRequest requests all states
message ListStatesRequest {}

// ListStatesResponse returns all states with basic info
message ListStatesResponse {
  repeated StateInfo states = 1;
}

// StateInfo is summary information for a state
message StateInfo {
  string guid = 1;
  string logic_id = 2;
  bool locked = 3;
  google.protobuf.Timestamp created_at = 4;
  google.protobuf.Timestamp updated_at = 5;
}

// BackendConfig contains Terraform backend configuration URLs
message BackendConfig {
  string address = 1;
  string lock_address = 2;
  string unlock_address = 3;
}

// GetStateConfigRequest retrieves backend config for existing state
message GetStateConfigRequest {
  string logic_id = 1;
}

// GetStateConfigResponse returns backend config
message GetStateConfigResponse {
  string guid = 1;
  BackendConfig backend_config = 2;
}

// GetStateLockRequest fetches current lock metadata by GUID
message GetStateLockRequest {
  string guid = 1;
}

// LockInfo mirrors Terraform's lock payload
message LockInfo {
  string id = 1;
  string operation = 2;
  string info = 3;
  string who = 4;
  string version = 5;
  google.protobuf.Timestamp created = 6;
  string path = 7;
}

// StateLock response wrapper indicating lock state plus metadata when present
message StateLock {
  bool locked = 1;
  LockInfo info = 2;
}

// GetStateLockResponse returns current lock status
message GetStateLockResponse {
  StateLock lock = 1;
}

// UnlockStateRequest releases a lock given the current lock ID
message UnlockStateRequest {
  string guid = 1;
  string lock_id = 2;
}

// UnlockStateResponse mirrors GetStateLockResponse after unlock attempt
message UnlockStateResponse {
  StateLock lock = 1;
}
```

## Validation Rules

### Logic ID Validation
- **Format**: `^[a-zA-Z0-9_-]+$`
- **Length**: 1-128 characters
- **Uniqueness**: Global (checked at database level)
- **Error on duplicate**: "State with logic_id '{logic_id}' already exists"

### GUID Validation
- **Format**: RFC 9562 UUIDv7 recommended; accept any RFC 4122 UUID
- **Generation**: Client-side (CLI) before calling CreateState
- **Immutability**: Never changed after creation

### State Content Validation
- **Format**: Must be valid JSON (validated by Terraform, not by Grid)
- **Size**: No hard limit, warning at 10MB
- **Encoding**: Stored as BYTEA in PostgreSQL for opaque content handling

### Lock Info Validation
- **Required fields**: ID, Operation, Created, Path
- **Optional fields**: Info, Who, Version
- **Consistency**: Must exist when locked=true, must be null when locked=false

## Internal Repository Operations

These methods compose the `StateRepository` interface inside `cmd/gridapi/internal/db/repository`; SDKs never call them directly.

### Create
```go
Create(ctx context.Context, record *State) error
```
- Accepts State with GUID already set by client (UUIDv7)
- Validates GUID format and logic_id uniqueness
- Insert with provided guid, logic_id, locked=false, state_content=null
- Return error if logic_id already exists (unique constraint violation)
- Return error if guid already exists (should be impossible with UUIDv7, but defensive)

### GetByGUID
```go
GetByGUID(ctx context.Context, guid string) (*State, error)
```
- SELECT by guid primary key (includes lock metadata)
- Return error if not found

### GetByLogicID
```go
GetByLogicID(ctx context.Context, logicID string) (*State, error)
```
- SELECT by logic_id unique index (includes lock metadata)
- Return error if not found

### Update
```go
Update(ctx context.Context, record *State) error
```
- UPDATE state_content, locked flag, or lock_info via structured updates
- Check size threshold, log warning if exceeded
- Return error if state not found or locked when update violates lock semantics

### List
```go
List(ctx context.Context) ([]State, error)
```
- SELECT all states ORDER BY created_at DESC
- Return empty slice if no states

### Lock
```go
Lock(ctx context.Context, guid string, lockInfo *LockInfo) error
```
- Atomic check-and-set: UPDATE locked=true, lock_info={...} WHERE guid={guid} AND locked=false
- Return error if already locked (affected rows = 0)
- Error should include existing lock_info for client

### Unlock
```go
Unlock(ctx context.Context, guid string, lockID string) error
```
- Verify lock_info.ID matches lockID parameter
- UPDATE locked=false, lock_info=null WHERE guid={guid} AND lock_info->>'ID'={lockID}
- Return error if lock_info.ID doesn't match (someone else's lock)

## Error Scenarios

### Duplicate Logic ID
- **Trigger**: Create state with existing logic_id
- **Response**: 409 Conflict (Connect RPC: ALREADY_EXISTS)
- **Message**: "State with logic_id 'production-us-east' already exists"

### State Not Found
- **Trigger**: GET/POST/LOCK/UNLOCK to non-existent GUID
- **Response**: 404 Not Found (Connect RPC: NOT_FOUND)
- **Message**: "State with guid '{guid}' not found"

### Lock Conflict
- **Trigger**: LOCK request when already locked
- **Response**: 423 Locked (Connect RPC: FAILED_PRECONDITION)
- **Body**: JSON with existing lock_info

### Invalid Unlock
- **Trigger**: UNLOCK with wrong lock ID
- **Response**: 400 Bad Request (Connect RPC: INVALID_ARGUMENT)
- **Message**: "Lock ID mismatch"

### State Content Update While Locked
- **Trigger**: POST to locked state
- **Response**: 423 Locked
- **Message**: "State is locked, cannot update"

## Data Model Summary

Single-entity model with State as the core entity. All state metadata (GUID, logic_id, lock status) and content live in a single PostgreSQL table with native UUID type (no extensions required). **Client generates UUIDv7** for optimal Postgres index performance and reduced API roundtrips. The repository pattern sits entirely within `cmd/gridapi/internal` atop Bun ORM migrations, while SDKs rely solely on generated Connect clients for contract-centric access, including lock inspection and unlock helpers. Terraform HTTP Backend interacts directly with REST handlers, not through SDK (constitutional exception).

Ready for contract generation.
